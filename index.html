<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>2025 QUANTUM ARCHIVE</title>

<style>
body {
    margin: 0;
    overflow: hidden;
    background: #000;
    font-family: 'Courier New', Courier, monospace;
}

#ui {
    position: absolute;
    top: 20px;
    left: 20px;
    color: #0f0;
    pointer-events: none;
    text-transform: uppercase;
    letter-spacing: 2px;
}

#controls {
    position: absolute;
    top: 20px;
    right: 20px;
}

button {
    background: transparent;
    border: 1px solid #0f0;
    color: #0f0;
    padding: 8px 14px;
    cursor: pointer;
    font-family: inherit;
}

button:hover {
    background: #0f0;
    color: #000;
}

#loadingBox {
    position: absolute;
    bottom: 60px;
    left: 50%;
    transform: translateX(-50%);
    width: 300px;
    border: 1px solid #0f0;
    padding: 4px;
}

#loadingBar {
    height: 14px;
    width: 0%;
    background: #0f0;
    transition: width 0.5s ease;
}

#loadingText {
    text-align: center;
    color: #0f0;
    font-size: 12px;
    margin-top: 6px;
}

.instruction {
    position: absolute;
    bottom: 20px;
    width: 100%;
    text-align: center;
    color: #444;
    font-size: 12px;
}

canvas { display: block; }
</style>
</head>
<body>

<div id="ui">
    <h1>Quantum Archive: 2025</h1>
    <p id="status">> Hệ thống: Đang tải ký ức...</p>
    <p id="counter">Tọa độ: 0.00, 0.00, 0.00</p>
</div>

<div id="controls">
    <button id="resetBtn">RESET</button>
</div>

<div id="loadingBox">
    <div id="loadingBar"></div>
    <div id="loadingText">ARCHIVE 2025: 0%</div>
</div>

<div class="instruction">
    Dùng ↑ ↓ ← → để di chuyển | Di chuột để nhìn | Click ảnh để truy xuất
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

<script>
/* ===================== DATA ===================== */
const memoryImages = Array.from({ length: 10 }, (_, i) =>
    `https://picsum.photos/800/600?random=${i + 1}`
);

const MOVE_SPEED = 0.6;
const viewedMemories = new Set();

/* ===================== INPUT ===================== */
const move = { forward:false, backward:false, left:false, right:false };

window.addEventListener('keydown', e => {
    if (e.key === 'ArrowUp') move.forward = true;
    if (e.key === 'ArrowDown') move.backward = true;
    if (e.key === 'ArrowLeft') move.left = true;
    if (e.key === 'ArrowRight') move.right = true;
});

window.addEventListener('keyup', e => {
    if (e.key === 'ArrowUp') move.forward = false;
    if (e.key === 'ArrowDown') move.backward = false;
    if (e.key === 'ArrowLeft') move.left = false;
    if (e.key === 'ArrowRight') move.right = false;
});

/* ===================== SCENE ===================== */
const scene = new THREE.Scene();
scene.fog = new THREE.FogExp2(0x000000, 0.015);

const camera = new THREE.PerspectiveCamera(
    75,
    window.innerWidth / window.innerHeight,
    0.1,
    1000
);
camera.position.set(0, 0, 50);
const startPosition = camera.position.clone();

const renderer = new THREE.WebGLRenderer({ antialias:true });
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

/* ===================== OBJECTS ===================== */
const loader = new THREE.TextureLoader();
const photoGroups = [];

memoryImages.forEach((url, index) => {
    const mesh = new THREE.Mesh(
        new THREE.PlaneGeometry(4, 3),
        new THREE.MeshBasicMaterial({
            map: loader.load(url),
            transparent: true,
            opacity: 0.85,
            side: THREE.DoubleSide
        })
    );

    mesh.position.set(
        (Math.random() - 0.5) * 40,
        (Math.random() - 0.5) * 40,
        (Math.random() - 0.5) * 100
    );

    mesh.userData.id = index;
    scene.add(mesh);
    photoGroups.push(mesh);
});

/* ===================== STARFIELD ===================== */
const starGeo = new THREE.BufferGeometry();
const starPos = [];

for (let i = 0; i < 5000; i++) {
    starPos.push(
        (Math.random() - 0.5) * 200,
        (Math.random() - 0.5) * 200,
        (Math.random() - 0.5) * 200
    );
}

starGeo.setAttribute('position', new THREE.Float32BufferAttribute(starPos, 3));
const stars = new THREE.Points(
    starGeo,
    new THREE.PointsMaterial({ color: 0x00ff00, size: 0.1 })
);
scene.add(stars);

/* ===================== MOUSE LOOK (FIXED) ===================== */
let targetRotX = 0;
let targetRotY = 0;
const MOUSE_SENSITIVITY = 0.002;

document.addEventListener('mousemove', e => {
    const dx = e.clientX - window.innerWidth / 2;
    const dy = e.clientY - window.innerHeight / 2;

    targetRotY = -dx * MOUSE_SENSITIVITY;
    targetRotX = -dy * MOUSE_SENSITIVITY;

    targetRotX = Math.max(
        -Math.PI / 2 + 0.1,
        Math.min(Math.PI / 2 - 0.1, targetRotX)
    );
});

/* ===================== CLICK MEMORY ===================== */
const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();

window.addEventListener('click', e => {
    mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
    mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;

    raycaster.setFromCamera(mouse, camera);
    const hits = raycaster.intersectObjects(photoGroups);
    if (!hits.length) return;

    const target = hits[0].object;
    document.getElementById('status').innerText =
        `> Truy xuất: MEMORY_${target.userData.id}`;

    gsap.to(camera.position, {
        x: target.position.x,
        y: target.position.y,
        z: target.position.z + 6,
        duration: 1.4,
        ease: "expo.out"
    });

    if (!viewedMemories.has(target.userData.id)) {
        viewedMemories.add(target.userData.id);
        updateLoading();
    }
});

/* ===================== RESET ===================== */
document.getElementById('resetBtn').onclick = () => {
    gsap.to(camera.position, {
        x: startPosition.x,
        y: startPosition.y,
        z: startPosition.z,
        duration: 1.5,
        ease: "power2.out"
    });
};

/* ===================== LOADING ===================== */
function updateLoading() {
    const percent = Math.round(
        (viewedMemories.size / memoryImages.length) * 100
    );
    document.getElementById('loadingBar').style.width = percent + "%";
    document.getElementById('loadingText').innerText =
        `ARCHIVE 2025: ${percent}%`;

    if (percent === 100) {
        document.getElementById('status').innerText =
            "> ARCHIVE 2025: HOÀN TẤT";
    }
}

/* ===================== LOOP ===================== */
const direction = new THREE.Vector3();
const right = new THREE.Vector3();

function animate() {
    requestAnimationFrame(animate);

    // mouse look smooth
    camera.rotation.y += (targetRotY - camera.rotation.y) * 0.08;
    camera.rotation.x += (targetRotX - camera.rotation.x) * 0.08;

    camera.getWorldDirection(direction);
    right.crossVectors(direction, camera.up).normalize();

    if (move.forward)  camera.position.addScaledVector(direction, MOVE_SPEED);
    if (move.backward) camera.position.addScaledVector(direction, -MOVE_SPEED);
    if (move.left)     camera.position.addScaledVector(right, -MOVE_SPEED);
    if (move.right)    camera.position.addScaledVector(right, MOVE_SPEED);

    stars.rotation.z += 0.0005;

    document.getElementById('counter').innerText =
        `Tọa độ: ${camera.position.x.toFixed(2)}, ${camera.position.y.toFixed(2)}, ${camera.position.z.toFixed(2)}`;

    renderer.render(scene, camera);
}

animate();

/* ===================== RESIZE ===================== */
window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});

document.getElementById('status').innerText = "> Hệ thống: Đã sẵn sàng.";
</script>
</body>
</html>
